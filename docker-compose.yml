# Docker Compose for Drawink
#
# Development mode: docker-compose -f docker-compose.yml up
# Production mode: docker-compose -f docker-compose.yml up drawink

services:
  # Production build (all services in one container)
  drawink:
    build:
      context: .
      args:
        - NODE_ENV=production
    container_name: drawink
    ports:
      - "3000:3000" # Frontend (nginx)
    restart: on-failure
    healthcheck:
      test: [ "CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:3000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    environment:
      - NODE_ENV=production
    profiles:
      - production

  # Development mode: Run services separately for hot reload
  frontend:
    image: oven/bun:1
    container_name: drawink-frontend
    working_dir: /app
    command: sh -c "bun install && cd apps/web && bun run dev"
    ports:
      - "3000:5173"
    volumes:
      - .:/app
      - node_modules:/app/node_modules
    environment:
      - VITE_APP_BACKEND_V2_GET_URL=http://api:3001/api/v2/
      - VITE_APP_BACKEND_V2_POST_URL=http://api:3001/api/v2/post
      - VITE_APP_WS_SERVER_URL=http://ws:3003
      - VITE_APP_PORT=5173
      - VITE_APP_DISABLE_SENTRY=true
      - VITE_APP_DISABLE_OPEN=true
      - VITE_APP_ENABLE_PWA=true
      - VITE_APP_FIREBASE_CONFIG={"apiKey":"AIzaSyCAUHzaqdecV3dGtNOTdO6jFich5K4mZOc","authDomain":"drawink-2026.firebaseapp.com","projectId":"drawink-2026","storageBucket":"drawink-2026.firebasestorage.app","messagingSenderId":"731425062456","appId":"1:731425062456:web:2994221d82e8eb01c9f0cd"}
      - VITE_CLERK_PUBLISHABLE_KEY=pk_test_bG95YWwtdmVydmV0LTMuY2xlcmsuYWNjb3VudHMuZGV2JA
      - VITE_APP_ENABLE_TRACKING=true
    depends_on:
      - api
      - ws
    profiles:
      - dev

  api:
    image: oven/bun:1
    container_name: drawink-api
    working_dir: /app
    command: sh -c "bun install && cd apps/api && bun run dev"
    ports:
      - "3001:3001"
    volumes:
      - .:/app
      - node_modules:/app/node_modules
    environment:
      - PORT=3001
      - JSON_BACKEND_PORT=3001
      - GOOGLE_APPLICATION_CREDENTIALS=/app/firebase-project/drawink-2026-firebase-adminsdk.json
    profiles:
      - dev

  ws:
    image: oven/bun:1
    container_name: drawink-ws
    working_dir: /app
    command: sh -c "bun install && cd apps/ws && bun run dev"
    ports:
      - "3003:3003"
    volumes:
      - .:/app
      - node_modules:/app/node_modules
    environment:
      - PORT=3003
      - WEBSOCKET_SERVER_PORT=3003
      - CORS_ORIGIN=*
    profiles:
      - dev

volumes:
  node_modules:
